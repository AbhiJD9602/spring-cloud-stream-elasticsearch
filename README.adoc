= `spring-cloud-stream-elasticsearch`

The goal of this project is to implement a "News" processing pipeline composed of 5 microservices: `producer-api`,
`categorizer-service`, `collector-service`, `publisher-api` and `news-client`.

* We are using https://docs.spring.io/spring-cloud-stream/docs/current/reference/htmlsingle[Spring Cloud Stream]
framework for building highly scalable event-driven microservices connected with shared messaging systems.

* We are using https://docs.spring.io/spring-data/elasticsearch/docs/current/reference/html/[Spring Data Elasticsearch]
to persist data in https://www.elastic.co/products/elasticsearch[Elasticsearch].

* We are using https://www.thymeleaf.org/[Thymeleaf] as HTML template

* We are using https://zipkin.io[Zipkin] for visualizing traces between and within microservices.

* We are using https://github.com/Netflix/eureka/wiki[Eureka], also known as Discovery Server, it is an application that holds the information about all
microservices.

== Microservices

image::images/project-diagram.png[]

=== producer-api
Spring-boot application that creates news and pushes news events to `producer.news` kafka topic.

=== categorizer-service
Spring-boot application that listens for news events in `producer.news` kafka topic, categorizes and pushes them to
`categorizer.news` kafka topic.

=== collector-service
Spring-boot application that listens for news events in `categorizer.news` kafka topic, saves them in Elasticsearch and
pushes the news events to `collector.news` kafka topic.

=== publisher-api
Spring-boot application that reads directly from Elasticsearch and exposes a REST. It doesn't listen from kafka.

=== news-client
Spring-boot application that provides a News user interface. It implements a `Websocket` that consumes news events from
the topic `collector.news`. So, news are updated on the fly on the main page. Besides, `news-client` communicates directly
with `publisher-api` whenever search for a specific news or news update are needed.

The Websocket operation is shown in the short gif below. A news is created in `producer-api` and, immediately, it is
shown in `news-client`.

image::images/websocket-operation.gif[]

== Generate NewsEvent

In `spring-cloud-stream-elasticsearch` folder run
```
./mvnw clean install --projects commons-news
```
It will install `commons-news-0.0.1-SNAPSHOT.jar` in you local Maven repository, so that it can be visible by all services.

== Build Docker images

=== eureka-server
```
./mvnw clean package dockerfile:build -DskipTests --projects eureka-server
```

=== producer-api
```
./mvnw clean package dockerfile:build -DskipTests --projects producer-api
```
|===
|Environment Variable | Description

|`KAFKA_HOST`
|Specify host of the `Kafka` message broker to use (default `localhost`)

|`KAFKA_PORT`
|Specify port of the `Kafka` message broker to use (default `29092`)

|`EUREKA_HOST`
|Specify host of the `Eureka` service discovery to use (default `localhost`)

|`EUREKA_PORT`
|Specify port of the `Eureka` service discovery to use (default `8761`)

|`ZIPKIN_HOST`
|Specify host of the `Zipkin` distributed tracing system to use (default `localhost`)

|`ZIPKIN_PORT`
|Specify port of the `Zipkin` distributed tracing system to use (default `9411`)

|===

=== categorizer-service
```
./mvnw clean package dockerfile:build -DskipTests --projects categorizer-service
```
|===
|Environment Variable | Description

|`KAFKA_HOST`
|Specify host of the `Kafka` message broker to use (default `localhost`)

|`KAFKA_PORT`
|Specify port of the `Kafka` message broker to use (default `29092`)

|`EUREKA_HOST`
|Specify host of the `Eureka` service discovery to use (default `localhost`)

|`EUREKA_PORT`
|Specify port of the `Eureka` service discovery to use (default `8761`)

|`ZIPKIN_HOST`
|Specify host of the `Zipkin` distributed tracing system to use (default `localhost`)

|`ZIPKIN_PORT`
|Specify port of the `Zipkin` distributed tracing system to use (default `9411`)

|===

=== collector-service
```
./mvnw clean package dockerfile:build -DskipTests --projects collector-service
```
|===
|Environment Variable | Description

|`ELASTICSEARCH_HOST`
|Specify host of the `Elasticsearch` search engine to use (default `localhost`)

|`ELASTICSEARCH_PORT`
|Specify port of the `Elasticsearch` search engine to use (default `9300`)

|`KAFKA_HOST`
|Specify host of the `Kafka` message broker to use (default `localhost`)

|`KAFKA_PORT`
|Specify port of the `Kafka` message broker to use (default `29092`)

|`EUREKA_HOST`
|Specify host of the `Eureka` service discovery to use (default `localhost`)

|`EUREKA_PORT`
|Specify port of the `Eureka` service discovery to use (default `8761`)

|`ZIPKIN_HOST`
|Specify host of the `Zipkin` distributed tracing system to use (default `localhost`)

|`ZIPKIN_PORT`
|Specify port of the `Zipkin` distributed tracing system to use (default `9411`)

|===

=== publisher-api
```
./mvnw clean package dockerfile:build -DskipTests --projects publisher-api
```
|===
|Environment Variable | Description

|`ELASTICSEARCH_HOST`
|Specify host of the `Elasticsearch` search engine to use (default `localhost`)

|`ELASTICSEARCH_PORT`
|Specify port of the `Elasticsearch` search engine to use (default `9300`)

|`EUREKA_HOST`
|Specify host of the `Eureka` service discovery to use (default `localhost`)

|`EUREKA_PORT`
|Specify port of the `Eureka` service discovery to use (default `8761`)

|`ZIPKIN_HOST`
|Specify host of the `Zipkin` distributed tracing system to use (default `localhost`)

|`ZIPKIN_PORT`
|Specify port of the `Zipkin` distributed tracing system to use (default `9411`)

|===

=== news-client
```
./mvnw clean package dockerfile:build -DskipTests --projects news-client
```
|===
|Environment Variable | Description

|`KAFKA_HOST`
|Specify host of the `Kafka` message broker to use (default `localhost`)

|`KAFKA_PORT`
|Specify port of the `Kafka` message broker to use (default `29092`)

|`EUREKA_HOST`
|Specify host of the `Eureka` service discovery to use (default `localhost`)

|`EUREKA_PORT`
|Specify port of the `Eureka` service discovery to use (default `8761`)

|`ZIPKIN_HOST`
|Specify host of the `Zipkin` distributed tracing system to use (default `localhost`)

|`ZIPKIN_PORT`
|Specify port of the `Zipkin` distributed tracing system to use (default `9411`)

|===

== Start Environment

- Open one terminal

- In `spring-cloud-stream-elasticsearch` root folder run
```
docker-compose up -d
```
[NOTE]
====
To stop and remove containers, networks and volumes
```
docker-compose down -v
```
====

- Wait a little bit until all containers are Up (healthy). You can check their status running
```
docker-compose ps
```

== Microservice Links

|===
|Microservice |URL

|`producer-api`
|http://localhost:9080/swagger-ui.html

|`publisher-api`
|http://localhost:9083/swagger-ui.html

|`news-client`
|http://localhost:9084

|===

== Running microservices with Maven

During development, it is better to just run the microservices instead of always build the docker images and run it.
In order to do that, comment the microservice(s) in `docker-compose.yml` file or stop it if it is already running. Then,
run them with Maven Wrapper.

=== eureka-server
```
./mvnw spring-boot:run --projects eureka-server
```

=== producer-api
```
./mvnw spring-boot:run --projects producer-api -Dspring-boot.run.jvmArguments="-Dserver.port=9080"
```

=== categorizer-service
```
./mvnw spring-boot:run --projects categorizer-service -Dspring-boot.run.jvmArguments="-Dserver.port=9081"
```

=== collector-service
```
./mvnw spring-boot:run --projects collector-service -Dspring-boot.run.jvmArguments="-Dserver.port=9082"
```

=== publisher-api
```
./mvnw spring-boot:run --projects publisher-api -Dspring-boot.run.jvmArguments="-Dserver.port=9083"
```

=== news-client
```
./mvnw spring-boot:run --projects news-client -Dspring-boot.run.jvmArguments="-Dserver.port=9084"
```

== Useful links

=== Eureka

- Eureka can be accessed at http://localhost:8761

=== Kafka Topics UI

- Kafka Topics UI can be accessed at http://localhost:8085

=== Zipkin

- Zipkin can be accessed at http://localhost:9411

- In figure below is shown an example of all flow that a news passes, since `producer-api`, where it is created, until
`news-client` where it is consumed.

image::images/zipkin-sample.png[]

== TODO

- **add alias to the index**: wait for this feature be available in Spring Data Elasticsearch (https://jira.spring.io/browse/DATAES-192)

- news-client: bug. everytime sync is clicked, it enables websocket;
- news-client: if websocket is enabled/disabled, sync button should be disabled/enabled;
- news-client: implement pagination;

== Issues

I am facing the following exception. It seems related to sleuth & websocket. It started happen when I update spring-boot to
2.1.4 and also spring-cloud to Greenwich.SR1.
At class `com.mycompany.newsclient.bus.NewsStream.java`, line "simpMessagingTemplate.convertAndSend("/topic/news", news);"

> _"The workaround is to disable Sleuth's websocket messaging support via spring.sleuth.integration.websockets.enabled=false"_
https://github.com/spring-cloud/spring-cloud-sleuth/issues/1184

```
... ERROR [news-client,d18dbfca6f0585ec,0ab140955dcc177b,true] 5545 --- [container-0-C-1] o.s.m.s.b.SimpleBrokerMessageHandler     : Failed to send GenericMessage [payload=byte[161], headers={simpMessageType=MESSAGE, simpDestination=/topic/news, spanTraceId=d18dbfca6f0585ec, spanId=dad2c6dd978293e9, spanParentSpanId=0d8526540d74fdb5, nativeHeaders={spanTraceId=[d18dbfca6f0585ec], spanId=[dad2c6dd978293e9], spanParentSpanId=[0d8526540d74fdb5], spanSampled=[1]}, spanSampled=1, contentType=application/json;charset=UTF-8}]

org.springframework.messaging.MessageDeliveryException: Failed to send message to ExecutorSubscribableChannel[clientOutboundChannel]; nested exception is java.lang.UnsupportedOperationException
        at org.springframework.messaging.support.AbstractMessageChannel.send(AbstractMessageChannel.java:146) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.support.AbstractMessageChannel.send(AbstractMessageChannel.java:122) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.simp.broker.SimpleBrokerMessageHandler.lambda$sendMessageToSubscribers$0(SimpleBrokerMessageHandler.java:401) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at java.util.Map.forEach(Map.java:630) ~[na:1.8.0_102]
        at org.springframework.messaging.simp.broker.SimpleBrokerMessageHandler.sendMessageToSubscribers(SimpleBrokerMessageHandler.java:388) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.simp.broker.SimpleBrokerMessageHandler.handleMessageInternal(SimpleBrokerMessageHandler.java:304) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.simp.broker.AbstractBrokerMessageHandler.handleMessage(AbstractBrokerMessageHandler.java:256) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.support.ExecutorSubscribableChannel$SendTask.run(ExecutorSubscribableChannel.java:144) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.support.ExecutorSubscribableChannel.sendInternal(ExecutorSubscribableChannel.java:100) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.support.AbstractMessageChannel.send(AbstractMessageChannel.java:136) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.support.AbstractMessageChannel.send(AbstractMessageChannel.java:122) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.simp.SimpMessagingTemplate.sendInternal(SimpMessagingTemplate.java:187) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.simp.SimpMessagingTemplate.doSend(SimpMessagingTemplate.java:162) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.simp.SimpMessagingTemplate.doSend(SimpMessagingTemplate.java:48) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.core.AbstractMessageSendingTemplate.send(AbstractMessageSendingTemplate.java:109) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.core.AbstractMessageSendingTemplate.convertAndSend(AbstractMessageSendingTemplate.java:151) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.core.AbstractMessageSendingTemplate.convertAndSend(AbstractMessageSendingTemplate.java:129) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.core.AbstractMessageSendingTemplate.convertAndSend(AbstractMessageSendingTemplate.java:122) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at com.mycompany.newsclient.bus.NewsStream.handleNewsEvent(NewsStream.java:44) ~[classes/:na]
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:1.8.0_102]
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:1.8.0_102]
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:1.8.0_102]
        at java.lang.reflect.Method.invoke(Method.java:498) ~[na:1.8.0_102]
        at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:170) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:120) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.cloud.stream.binding.StreamListenerMessageHandler.handleRequestMessage(StreamListenerMessageHandler.java:55) ~[spring-cloud-stream-2.1.2.RELEASE.jar:2.1.2.RELEASE]
        at org.springframework.integration.handler.AbstractReplyProducingMessageHandler.handleMessageInternal(AbstractReplyProducingMessageHandler.java:123) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.handler.AbstractMessageHandler.handleMessage(AbstractMessageHandler.java:162) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.dispatcher.AbstractDispatcher.tryOptimizedDispatch(AbstractDispatcher.java:115) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.dispatcher.UnicastingDispatcher.doDispatch(UnicastingDispatcher.java:132) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.dispatcher.UnicastingDispatcher.dispatch(UnicastingDispatcher.java:105) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.channel.AbstractSubscribableChannel.doSend(AbstractSubscribableChannel.java:73) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.channel.AbstractMessageChannel.send(AbstractMessageChannel.java:453) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.channel.AbstractMessageChannel.send(AbstractMessageChannel.java:401) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.messaging.core.GenericMessagingTemplate.doSend(GenericMessagingTemplate.java:187) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.core.GenericMessagingTemplate.doSend(GenericMessagingTemplate.java:166) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.core.GenericMessagingTemplate.doSend(GenericMessagingTemplate.java:47) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.core.AbstractMessageSendingTemplate.send(AbstractMessageSendingTemplate.java:109) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.integration.endpoint.MessageProducerSupport.sendMessage(MessageProducerSupport.java:205) ~[spring-integration-core-5.1.4.RELEASE.jar:5.1.4.RELEASE]
        at org.springframework.integration.kafka.inbound.KafkaMessageDrivenChannelAdapter.sendMessageIfAny(KafkaMessageDrivenChannelAdapter.java:369) ~[spring-integration-kafka-3.1.0.RELEASE.jar:3.1.0.RELEASE]
        at org.springframework.integration.kafka.inbound.KafkaMessageDrivenChannelAdapter.access$400(KafkaMessageDrivenChannelAdapter.java:74) ~[spring-integration-kafka-3.1.0.RELEASE.jar:3.1.0.RELEASE]
        at org.springframework.integration.kafka.inbound.KafkaMessageDrivenChannelAdapter$IntegrationRecordMessageListener.onMessage(KafkaMessageDrivenChannelAdapter.java:431) ~[spring-integration-kafka-3.1.0.RELEASE.jar:3.1.0.RELEASE]
        at org.springframework.integration.kafka.inbound.KafkaMessageDrivenChannelAdapter$IntegrationRecordMessageListener.onMessage(KafkaMessageDrivenChannelAdapter.java:402) ~[spring-integration-kafka-3.1.0.RELEASE.jar:3.1.0.RELEASE]
        at org.springframework.kafka.listener.adapter.RetryingMessageListenerAdapter.lambda$onMessage$0(RetryingMessageListenerAdapter.java:120) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.retry.support.RetryTemplate.doExecute(RetryTemplate.java:287) ~[spring-retry-1.2.4.RELEASE.jar:na]
        at org.springframework.retry.support.RetryTemplate.execute(RetryTemplate.java:211) ~[spring-retry-1.2.4.RELEASE.jar:na]
        at org.springframework.kafka.listener.adapter.RetryingMessageListenerAdapter.onMessage(RetryingMessageListenerAdapter.java:114) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.adapter.RetryingMessageListenerAdapter.onMessage(RetryingMessageListenerAdapter.java:40) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeOnMessage(KafkaMessageListenerContainer.java:1263) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeOnMessage(KafkaMessageListenerContainer.java:1256) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeRecordListener(KafkaMessageListenerContainer.java:1217) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.doInvokeWithRecords(KafkaMessageListenerContainer.java:1198) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeRecordListener(KafkaMessageListenerContainer.java:1118) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.invokeListener(KafkaMessageListenerContainer.java:933) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.pollAndInvoke(KafkaMessageListenerContainer.java:749) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at org.springframework.kafka.listener.KafkaMessageListenerContainer$ListenerConsumer.run(KafkaMessageListenerContainer.java:698) ~[spring-kafka-2.2.5.RELEASE.jar:2.2.5.RELEASE]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_102]
        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_102]
        at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_102]
Caused by: java.lang.UnsupportedOperationException: null
        at java.util.Collections$UnmodifiableMap.remove(Collections.java:1460) ~[na:1.8.0_102]
        at org.springframework.messaging.support.NativeMessageHeaderAccessor.removeNativeHeader(NativeMessageHeaderAccessor.java:209) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.cloud.sleuth.instrument.messaging.MessageHeaderPropagation.removeAnyTraceHeaders(MessageHeaderPropagation.java:86) ~[spring-cloud-sleuth-core-2.1.1.RELEASE.jar:2.1.1.RELEASE]
        at org.springframework.cloud.sleuth.instrument.messaging.TracingChannelInterceptor.preSend(TracingChannelInterceptor.java:173) ~[spring-cloud-sleuth-core-2.1.1.RELEASE.jar:2.1.1.RELEASE]
        at org.springframework.messaging.support.AbstractMessageChannel$ChannelInterceptorChain.applyPreSend(AbstractMessageChannel.java:178) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        at org.springframework.messaging.support.AbstractMessageChannel.send(AbstractMessageChannel.java:132) ~[spring-messaging-5.1.6.RELEASE.jar:5.1.6.RELEASE]
        ... 58 common frames omitted
```